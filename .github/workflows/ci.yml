name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci

      - name: Typecheck
        run: npx tsc --noEmit

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npx prettier --check "src/**/*.ts" "tests/**/*.ts"

  test-unit:
    needs: quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci

      - name: Run unit tests (no Valkey needed)
        run: >-
          npx vitest run
          tests/api-completeness.test.ts
          tests/az-affinity.test.ts
          tests/connection.test.ts
          tests/job.test.ts
          tests/queue.test.ts
          tests/recovery.test.ts
          tests/shutdown.test.ts
          tests/telemetry.test.ts
          tests/testing-mode.test.ts
          tests/worker-saturation.test.ts
          tests/worker.test.ts

  test-integration:
    needs: quality
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20, 22]
      fail-fast: false
    services:
      valkey:
        image: valkey/valkey:8.0
        options: >-
          --health-cmd "valkey-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - run: npm ci
      - run: npm run build

      - name: Verify Valkey standalone
        run: |
          node -e "
          const { GlideClient } = require('@glidemq/speedkey');
          (async () => {
            const c = await GlideClient.createClient({ addresses: [{ host: 'localhost', port: 6379 }] });
            console.log('PING:', await c.ping());
            c.close();
          })().catch(e => { console.error(e.message); process.exit(1); });
          "

      - name: Install Valkey binaries for cluster
        run: |
          id=$(docker create valkey/valkey:8.0)
          sudo docker cp "$id:/usr/local/bin/valkey-server" /usr/local/bin/valkey-server
          sudo docker cp "$id:/usr/local/bin/valkey-cli" /usr/local/bin/valkey-cli
          docker rm "$id"
          sudo chmod +x /usr/local/bin/valkey-server /usr/local/bin/valkey-cli
          valkey-server --version

      - name: Start Valkey cluster (7000-7005)
        run: bash tests/helpers/start-cluster.sh

      - name: Run integration tests (standalone + cluster)
        run: >-
          npx vitest run
          --exclude 'tests/api-completeness.test.ts'
          --exclude 'tests/az-affinity.test.ts'
          --exclude 'tests/connection.test.ts'
          --exclude 'tests/job.test.ts'
          --exclude 'tests/queue.test.ts'
          --exclude 'tests/recovery.test.ts'
          --exclude 'tests/shutdown.test.ts'
          --exclude 'tests/telemetry.test.ts'
          --exclude 'tests/testing-mode.test.ts'
          --exclude 'tests/worker-saturation.test.ts'
          --exclude 'tests/worker.test.ts'
