name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "20"

jobs:
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Checkout speedkey
        uses: actions/checkout@v4
        with:
          repository: avifenesh/speedkey
          path: speedkey

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.1"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install and build speedkey
        working-directory: speedkey/node
        run: npm install && npm run build:release

      - name: Install glide-mq dependencies
        run: npm install --ignore-scripts

      - name: Link speedkey into node_modules
        run: mkdir -p node_modules/@glidemq && rm -rf node_modules/@glidemq/speedkey && ln -s ${{ github.workspace }}/speedkey/node node_modules/@glidemq/speedkey

      - name: Typecheck
        run: npx tsc --noEmit

  test-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Checkout speedkey
        uses: actions/checkout@v4
        with:
          repository: avifenesh/speedkey
          path: speedkey

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.1"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install and build speedkey
        working-directory: speedkey/node
        run: npm install && npm run build:release

      - name: Install glide-mq dependencies
        run: npm install --ignore-scripts

      - name: Link speedkey into node_modules
        run: mkdir -p node_modules/@glidemq && rm -rf node_modules/@glidemq/speedkey && ln -s ${{ github.workspace }}/speedkey/node node_modules/@glidemq/speedkey

      - name: Run unit tests
        run: npx vitest run tests/connection.test.ts tests/job.test.ts tests/queue.test.ts tests/worker.test.ts tests/shutdown.test.ts tests/telemetry.test.ts tests/recovery.test.ts tests/api-completeness.test.ts

  test-integration:
    runs-on: ubuntu-latest
    services:
      valkey:
        image: valkey/valkey:8.0
        options: >-
          --health-cmd "valkey-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Checkout speedkey
        uses: actions/checkout@v4
        with:
          repository: avifenesh/speedkey
          path: speedkey

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.1"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install and build speedkey
        working-directory: speedkey/node
        run: npm install && npm run build:release

      - name: Install glide-mq dependencies
        run: npm install --ignore-scripts

      - name: Link speedkey into node_modules
        run: mkdir -p node_modules/@glidemq && rm -rf node_modules/@glidemq/speedkey && ln -s ${{ github.workspace }}/speedkey/node node_modules/@glidemq/speedkey

      - name: Compile TypeScript
        run: npx tsc

      - name: Verify Valkey standalone connection
        run: |
          node -e "
          const { GlideClient } = require('./node_modules/@glidemq/speedkey/build-ts');
          (async () => {
            const c = await GlideClient.createClient({ addresses: [{ host: 'localhost', port: 6379 }] });
            console.log('PING:', await c.ping());
            c.close();
          })().catch(e => { console.error('Connection failed:', e.message); process.exit(1); });
          "

      - name: Install Valkey binaries for cluster
        run: |
          id=$(docker create valkey/valkey:8.0)
          sudo docker cp "$id:/usr/local/bin/valkey-server" /usr/local/bin/valkey-server
          sudo docker cp "$id:/usr/local/bin/valkey-cli" /usr/local/bin/valkey-cli
          docker rm "$id"
          sudo chmod +x /usr/local/bin/valkey-server /usr/local/bin/valkey-cli
          valkey-server --version
          valkey-cli --version

      - name: Start Valkey cluster
        run: bash tests/helpers/start-cluster.sh

      - name: Run integration tests (standalone + cluster)
        run: npx vitest run tests/integration.test.ts tests/dedup.test.ts tests/delayed.test.ts tests/priority.test.ts tests/retry.test.ts tests/retention.test.ts tests/concurrency.test.ts tests/rate-limit.test.ts
